!function(){window.Opus=window.Opus||{},Opus.VERSION="0.1.0"}(),function(){if(!window.requestAnimationFrame||!window.cancelAnimationFrame){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];!window.requestAnimationFrame&&window.setTimeout&&(window.requestAnimationFrame=function(b){var c=Date.now(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c-d,e}),!window.cancelAnimationFrame&&window.clearTimeout&&(window.cancelAnimationFrame=function(a){window.clearTimeout(a)})}}(),function(){if(window.performance||(window.performance={}),!window.performance.now){var a=Date.now();window.performance.now=function(){return Date.now()-a}}}(),Opus.Helpers=function(){var a={global:0};return{getUniqueId:function(b,c){return b?a[b]?c?c+a[b]++:a[b]++ +"":(a[b]=0,c?c+a[b]++:a[b]++ +""):c?c+a.global++:a.global++ +""},checkUniqueIdIncrement:function(b){return b?a[b]+"":a.global+""},resetUniqueIdValues:function(b){if(b)a[b]=0;else for(var c=0;c<Object.keys(a).length;c++)a[c]=0},toTitleCase:function(a){var b=/^(a|an|and|as|at|but|by|en|for|if|in|nor|of|on|or|per|the|to|vs?\.?|via)$/i;return a.replace(/[A-Za-z0-9\u00C0-\u00FF]+[^\s-]*/g,function(a,c,d){return c>0&&c+a.length!==d.length&&a.search(b)>-1&&":"!==d.charAt(c-2)&&("-"!==d.charAt(c+a.length)||"-"===d.charAt(c-1))&&d.charAt(c-1).search(/[^\s-]/)<0?a.toLowerCase():a.substr(1).search(/[A-Z]|\../)>-1?a:a.charAt(0).toUpperCase()+a.substr(1)})},getAllKeys:function(a){if(!this.isObject(a))return[];var b=[];for(var c in a)b.push(c);return b},isFunction:function(a){var b=typeof a;return"function"===b&&!!a},isObject:function(a){var b=typeof a;return"function"===b||"object"===b&&!!a},isTrueObject:function(a){var b=typeof a;return"object"===b&&!!a},objectHasProperty:function(a,b){return"undefined"!=typeof a&&Object.prototype.hasOwnProperty.call(a,b)},extend:function(a,b,c,d){c=c||!1,d=d||!1;var e=[];e=d?Object.keys(b):this.getAllKeys(b);for(var f=0;f<e.length;f++){var g=e[f];c?a[g]=b[g]:"undefined"==typeof a[g]&&(a[g]=b[g])}return a},getPercent:function(a,b){return b/100*a},getScreenOffset:function(a){var b=document.documentElement,c=document.getElementById(a).getBoundingClientRect();c.top+window.pageYOffset-b.clientTop,c.left+window.pageXOffset-b.clientLeft;return $("#"+a).offset()},clamp:function(a,b,c){return Math.max(b,Math.min(c,a))}}}(),function(){Opus.Timer=function(){var a=0,b=0,c=0,d=0,e=0;return{fps:0,tick:1,init:function(){this.reset(),d=c=0},reset:function(){c=d=window.performance.now(),e=0,a=0,b=0},countFps:function(){a++,b+=e,a%10===0&&(this.fps=Math.floor(1e3*a/b),b=0,a=0)},getDeltaTime:function(){return Math.round(100*e)/100},getTimeElapsed:function(){return Math.round(d/1e3*100)/100},update:function(a){return c=d,d=a,e=d-c,this.tick=e/1e3,e}}}()}(),function(){Opus.Input=function(a){this.game=a,this.eventList={click:[],mousedown:[],mouseup:[]},this.mousePosition=new Opus.Vector2D,this.game.renderer.canvas.addEventListener("click",function(a){for(var b=0;b<this.eventList.click.length;b++)a.data?Opus.Helpers.extend(a.data,this.eventList.click[b].data,!1,!0):a.data=this.eventList.click[b].data,this.eventList.click[b].closure(a)}.bind(this)),this.game.renderer.canvas.addEventListener("mousedown",function(a){for(var b=0;b<this.eventList.mousedown.length;b++)a.data?Opus.Helpers.extend(a.data,this.eventList.mousedown[b].data,!1,!0):a.data=this.eventList.mousedown[b].data,this.eventList.mousedown[b].closure(a)}.bind(this)),this.game.renderer.canvas.addEventListener("mouseup",function(a){for(var b=0;b<this.eventList.mouseup.length;b++)a.data?Opus.Helpers.extend(a.data,this.eventList.mouseup[b].data,!1,!0):a.data=this.eventList.mouseup[b].data,this.eventList.mouseup[b].closure(a)}.bind(this)),this.game.renderer.canvas.addEventListener("mousemove",function(a){this.mousePosition.set((a.pageX-Opus.Helpers.getScreenOffset("game-screen").left)*this.game.renderer.scaleRatio.x,(a.pageY-Opus.Helpers.getScreenOffset("game-screen").top)*this.game.renderer.scaleRatio.y)}.bind(this))},Opus.Helpers.extend(Opus.Input.prototype,{addEvent:function(a,b,c){if(!this.eventList[a])throw Error("Event not set ["+a+"]");this.eventList[a].push({closure:b,data:c})}},!0)}(),function(){Opus.Vector2D=function(a,b){this.set(a||0,b||0)},Opus.Helpers.extend(Opus.Vector2D.prototype,{set:function(a,b){if(isNaN(a))throw new Error("Invalid x parameter for vector");if(isNaN(b))throw new Error("Invalid y parameter for vector");return this.x=a,this.y=b,this},add:function(a){return new Opus.Vector2D(this.x+a.x,this.y+a.y)},addTo:function(a){return this.x+=a.x,this.y+=a.y,this},subtract:function(a){return new Opus.Vector2D(this.x-a.x,this.y-a.y)},subtractFrom:function(a){return this.x-=a.x,this.y-=a.y,this},multiplyScalar:function(a){return new Opus.Vector2D(this.x*a,this.y*a)},multiplyByScalar:function(a){return this.x*=a,this.y*=a,this},divideScalar:function(a){return new Opus.Vector2D(this.x/a,this.y/a)},divideByScalar:function(a){return this.x/=a,this.y/=a,this},setAngle:function(a){var b=this.getLength();this.x=Math.cos(a)*b,this.y=Math.sin(a)*b},getAngle:function(){return Math.atan2(this.y,this.x)},setLength:function(a){var b=this.getAngle();this.x=Math.cos(b)*a,this.y=Math.sin(b)*a},getLength:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},invertX:function(){return this.x*=-1,this},invertY:function(){return this.y*=-1,this},invert:function(){return this.invertX(),this.invertY(),this}},!0)}(),function(){Opus.Renderer=function(a,b,c){return this.scaleRatio=new Opus.Vector2D,this.canvas=this.createCanvas(a,b),this.wrapper=document.getElementById("game-screen"),this.wrapper.appendChild(this.canvas),this.context=this.canvas.getContext("2d"),this.scaleRatio.set(this.canvas.width/this.canvas.offsetWidth,this.canvas.height/this.canvas.offsetHeight),this.doubleBufferingEnabled=c||!1,this.doubleBufferingEnabled?(this.backBuffer=this.createCanvas(a,b),this.backBufferContext=this.backBuffer.getContext("2d")):(this.backBuffer=this.canvas,this.backBufferContext=this.context),this},Opus.Helpers.extend(Opus.Renderer.prototype,{createCanvas:function(a,b){if(0===a||0===b)throw Error("Width and height need to be greater than zero for canvas creation.");var c=document.createElement("canvas");c.width=a||this.canvas.width,c.height=b||this.canvas.height;var d=window.innerWidth/a,e=window.innerHeight/b,f=window.innerWidth/window.innerHeight,g=Math.min(d,e);return f>=1.77&&1.79>=f?(c.style.width=window.innerWidth+"px",c.style.height=window.innerHeight+"px"):(c.style.width=a*g+"px",c.style.height=b*g+"px"),c},getContext:function(){return this.backBufferContext},clearScreen:function(a){return this.backBufferContext.save(),this.backBufferContext.setTransform(1,0,0,1,0,0),this.backBufferContext.fillStyle=a||"black",this.backBufferContext.fillRect(0,0,this.canvas.width,this.canvas.height),this.backBufferContext.restore(),this},drawFrontBuffer:function(){return this.context.drawImage(this.backBuffer,0,0),this}},!0)}(),function(){Opus.Tower=function(a,b,c,d,e,f){return this.game=a,this.level=b.level,this.range=b.range,this.attacksPerSecond=b.attacksPerSecond,this.damage=b.damage,this.cost=b.cost,this.name=b.name,this.color=b.color,this.levelAvailable=b.levelAvailable,this.position=new Opus.Vector2D(c,d),this.width=e,this.height=f,this.lockedTarget=null,this},Opus.Helpers.extend(Opus.Tower.prototype,{lastAttackTime:0,attack:function(a){var b=1/this.attacksPerSecond,c=(a-this.lastAttackTime)/1e3;c>b&&(this.lockedTarget.health-=this.damage,this.lastAttackTime=a)},render:function(a){return a.strokeStyle=this.color,a.lineWidth=2,a.strokeRect(this.position.x,this.position.y,this.width,this.height),a.strokeStyle="#fff",a.lineWidth=1,a.beginPath(),a.arc(this.position.x+this.game.activeMap.cellSize/2,this.position.y+this.game.activeMap.cellSize/2,this.game.activeMap.cellSize*this.range,0,2*Math.PI),a.stroke(),a.strokeStyle=this.color,a.lineWidth=1,a.beginPath(),a.arc(this.position.x+this.game.activeMap.cellSize/2,this.position.y+this.game.activeMap.cellSize/2,2,0,2*Math.PI),a.fillStyle=this.color,a.fill(),a.stroke(),a.lineWidth=1,a.beginPath(),a.moveTo(this.position.x+this.game.activeMap.cellSize/2,this.position.y+this.game.activeMap.cellSize/2),a.lineTo(this.position.x,this.position.y+this.game.activeMap.cellSize),a.stroke(),this.lockedTarget&&(a.strokeStyle=this.color,a.lineWidth=.5,a.beginPath(),a.moveTo(this.position.x+this.game.activeMap.cellSize/2,this.position.y+this.game.activeMap.cellSize/2),a.lineTo(this.lockedTarget.position.x,this.lockedTarget.position.y),a.stroke()),this},update:function(a){return this.findNearestEnemyInRange(),this.lockedTarget&&this.attack(a),this},findNearestEnemyInRange:function(){for(var a=[],b=0;b<this.game.container.containedEntities.length;b++){var c=this.game.container.containedEntities[b];c instanceof Opus.Enemy&&this.enemyIsInRange(c.position,c.width,c.height)&&a.push(c)}for(b=0;b<a.length;b++)return this.lockedTarget=this.findNearestEnemy(a),!0;return this.lockedTarget=null,!1},findNearestEnemy:function(a){for(var b=[],c=0;c<a.length;c++)b[c]=this.calculateDistanceToEnemy(a[c]);var d=0;for(c=0;c<b.length;c++)b[c]<b[d]&&(d=c);return a[d]},calculateDistanceToEnemy:function(a){var b=Math.max(Math.min(this.position.x,a.position.x+a.width),a.position.x),c=Math.max(Math.min(this.position.y,a.position.y+a.height),a.position.y);return Math.sqrt((this.position.x-b)*(this.position.x-b)+(this.position.y-c)*(this.position.y-c))},enemyIsInRange:function(a,b,c){var d=Opus.Helpers.clamp(this.position.x+this.game.activeMap.cellSize/2,a.x,a.x+b),e=Opus.Helpers.clamp(this.position.y+this.game.activeMap.cellSize/2,a.y,a.y+c),f=this.position.x+this.game.activeMap.cellSize/2-d,g=this.position.y+this.game.activeMap.cellSize/2-e,h=f*f+g*g;return h<this.game.activeMap.cellSize*this.range*(this.game.activeMap.cellSize*this.range)}},!0)}(),function(){Opus.UI=function(a,b,c){return this.canvasWidth=b,this.canvasHeight=c,this.game=a,this.topBar={width:this.canvasWidth-Opus.Helpers.getPercent(this.canvasWidth,20),height:Opus.Helpers.getPercent(this.canvasHeight,10),offset:{top:0,left:0}},this.sideBar={width:Opus.Helpers.getPercent(this.canvasWidth,20),height:this.canvasHeight,offset:{top:0,left:this.canvasWidth-Opus.Helpers.getPercent(this.canvasWidth,20)}},this.mapContainer={width:this.canvasWidth-this.sideBar.width-20,height:this.canvasHeight-this.topBar.height-20,offset:{top:this.topBar.height+10,left:10}},this.game.input.addEvent("mousedown",this.mouseDown,{self:this}),this},Opus.Helpers.extend(Opus.UI.prototype,{render:function(a){return this.drawContainers(a),a.font="40px Arial",a.strokeText("Canvas TD",20,50),this.drawPlayerInformation(a),this.drawTowerPanel(a),this.drawTowers(a),this.game.selectedTower&&this.game.addTopLevelRenderObject(this.drawSelectedTower.bind(this)),this},update:function(a){return this.game.selectedTower&&this.game.selectedTower.position.set(this.game.input.mousePosition.x,this.game.input.mousePosition.y),this},drawSelectedTower:function(a){var b=this.game.selectedTower;a.strokeStyle=b.color,a.lineWidth=2,a.strokeRect(b.position.x-this.game.activeMap.cellSize/2,b.position.y-this.game.activeMap.cellSize/2,this.game.activeMap.cellSize,this.game.activeMap.cellSize);var c=this.game.activeMap.findGridCell(b.position.x,b.position.y);return c&&"P"==this.game.activeMap.getMapElement(c.x,c.y)&&(a.fillStyle="red",a.fillRect(b.position.x-this.game.activeMap.cellSize/2,b.position.y-this.game.activeMap.cellSize/2,this.game.activeMap.cellSize,this.game.activeMap.cellSize)),c&&"."==this.game.activeMap.getMapElement(c.x,c.y)&&(a.fillStyle="lightgreen",a.fillRect(b.position.x-this.game.activeMap.cellSize/2,b.position.y-this.game.activeMap.cellSize/2,this.game.activeMap.cellSize,this.game.activeMap.cellSize)),a.strokeStyle="#fff",a.lineWidth=2,a.beginPath(),a.arc(b.position.x,b.position.y,this.game.activeMap.cellSize*b.range,0,2*Math.PI),a.stroke(),this},mouseDown:function(a){if(a.data.self.game.selectedTower){var b=a.data.self.game.activeMap.findGridCell(a.data.self.game.selectedTower.position.x,a.data.self.game.selectedTower.position.y);return b&&"."==a.data.self.game.activeMap.getMapElement(b.x,b.y)?(a.data.self.game.container.addEntity(new Opus.Tower(a.data.self.game,Opus.Helpers.extend({},a.data.self.game.selectedTower,!0),b.x*a.data.self.game.activeMap.cellSize+a.data.self.mapContainer.offset.left,b.y*a.data.self.game.activeMap.cellSize+a.data.self.mapContainer.offset.top,a.data.self.game.activeMap.cellSize,a.data.self.game.activeMap.cellSize)),delete a.data.self.game.selectedTower,!0):(delete a.data.self.game.selectedTower,!0)}for(var c=0;c<a.data.self.game.towers.length;c++){var d=a.data.self.game.towers[c];if(a.data.self.game.input.mousePosition.x>=d.position.x&&a.data.self.game.input.mousePosition.x<=d.position.x+d.width&&a.data.self.game.input.mousePosition.y>=d.position.y&&a.data.self.game.input.mousePosition.y<=d.position.y+d.height)return a.data.self.game.selectedTower=Opus.Helpers.extend({},d,!0),a.data.self.game.selectedTower.position=Opus.Helpers.extend({},d.position,!0),!0}},drawTowers:function(a){for(var b=0;b<this.game.towers.length;b++){var c=this.game.towers[b];c.position||(c.position=new Opus.Vector2D(this.sideBar.offset.left+25+b*this.game.activeMap.cellSize,this.topBar.height+20+this.game.activeMap.cellSize)),c.width||(c.width=this.game.activeMap.cellSize),c.height||(c.height=this.game.activeMap.cellSize),a.strokeStyle=c.color,a.lineWidth=2,a.strokeRect(this.sideBar.offset.left+25+b*this.game.activeMap.cellSize,this.topBar.height+20+this.game.activeMap.cellSize,this.game.activeMap.cellSize,this.game.activeMap.cellSize)}},drawTowerPanel:function(a){a.strokeStyle="#79d0e7",a.lineWidth=1,a.strokeRect(this.sideBar.offset.left+10,this.topBar.height,this.sideBar.width-10,300),a.strokeRect(this.sideBar.offset.left+20,this.topBar.height+10,this.sideBar.width-30,30),a.fillStyle="#ffffff",a.font="16px Verdana",a.fillText("Towers",this.sideBar.offset.left+30,this.topBar.height+30),a.strokeRect(this.sideBar.offset.left+10,this.topBar.height+310,this.sideBar.width-10,300)},drawPlayerInformation:function(a){return a.strokeStyle="#79d0e7",a.lineWidth=1,a.strokeRect(this.sideBar.offset.left-300,5,300,this.topBar.height-10),a.beginPath(),a.moveTo(this.sideBar.offset.left-150,5),a.lineTo(this.sideBar.offset.left-150,this.topBar.height-5),a.stroke(),a.beginPath(),a.moveTo(this.sideBar.offset.left-300,this.topBar.height/2),a.lineTo(this.sideBar.offset.left,this.topBar.height/2),a.stroke(),a.fillStyle="#ffffff",a.font="16px Verdana",a.fillText("Bank",this.sideBar.offset.left-300+5,25),a.fillText("Â£"+this.game.player.money,this.sideBar.offset.left-300+95,25),a.fillText("Score",this.sideBar.offset.left-300+5,50),a.fillText(this.game.player.score,this.sideBar.offset.left-300+95,50),a.fillText("Lives",this.sideBar.offset.left-300+155,25),a.fillText(this.game.player.lives+"/"+this.game.player.maxLives,this.sideBar.offset.left-300+245,25),a.fillText("Level",this.sideBar.offset.left-300+155,50),a.fillText(this.game.player.level+"/"+this.game.activeMap.settings.levels,this.sideBar.offset.left-300+245,50),this},drawContainers:function(a){return a.strokeStyle="#79d0e7",a.lineWidth=1,a.beginPath(),a.moveTo(this.topBar.offset.left,this.topBar.height),a.lineTo(this.topBar.width,this.topBar.height),a.moveTo(this.sideBar.offset.left,this.sideBar.offset.top),a.lineTo(this.sideBar.offset.left,this.sideBar.height),a.stroke(),a.strokeRect(this.mapContainer.offset.left,this.mapContainer.offset.top,this.mapContainer.width,this.mapContainer.height),a.fillStyle="black",a.fillRect(this.topBar.offset.left,this.topBar.offset.top,this.topBar.width,this.topBar.height),a.fillRect(this.sideBar.offset.left,this.sideBar.offset.top,this.sideBar.width,this.sideBar.height),a.fillRect(this.mapContainer.offset.left,this.mapContainer.offset.top,this.mapContainer.width,this.mapContainer.height),this}},!0)}(),function(){Opus.Map=function(a,b){return this.game=a,this.settings={map:[],mapNotation:{path:"P",ground:".",start:"S",end:"E"},cellsX:0,cellsY:0,groundLineColor:"#0c8280",groundColor:"#1a4843",pathColor:"#002323",pathLineColor:"#79d0e7",levels:0},Opus.Helpers.extend(this.settings,b,!0),this.container=a.UI.mapContainer,this.cellSize=this.container.height/this.settings.cellsY,this.mapWidth=this.cellSize*this.settings.cellsY,this.container.backgroundColor=this.settings.groundColor,this.container.offset.left=(this.container.width-this.mapWidth)/2,this.container.width=this.mapWidth,this.needsInitialising=!0,this.startCell=null,this.endCell=null,this.findStartCell(),this.findEndCell(),this},Opus.Helpers.extend(Opus.Map.prototype,{findGridCell:function(a,b){for(var c=0;c<this.settings.cellsX;c++)for(var d=0;d<this.settings.cellsY;d++)if(a<=this.container.offset.left+c*this.cellSize+this.cellSize&&a>=this.container.offset.left+c*this.cellSize&&b<=this.container.offset.top+d*this.cellSize+this.cellSize&&b>=this.container.offset.top+d*this.cellSize)return{x:c,y:d};return!1},findStartCell:function(){for(var a=0;a<this.settings.cellsX;a++)for(var b=0;b<this.settings.cellsY;b++)if(this.getMapElement(a,b)==this.settings.mapNotation.start){if(this.startCell)throw Error("Start cell already set!");this.startCell=new Opus.Vector2D(a,b)}},findEndCell:function(){for(var a=0;a<this.settings.cellsX;a++)for(var b=0;b<this.settings.cellsY;b++)if(this.getMapElement(a,b)==this.settings.mapNotation.end){if(this.endCell)throw Error("End cell already set!");this.endCell=new Opus.Vector2D(a,b)}},render:function(a){return this.drawGrid(a),this.drawPathBorders(a),this},update:function(a){return this.needsInitialising&&(this.initialiseLevel(),this.needsInitialising=!1),this},initialiseLevel:function(){var a=this,b=function(){a.addEnemy()};setTimeout(b,1e3),setTimeout(b,2e3),setTimeout(b,3e3),setTimeout(b,4e3),setTimeout(b,5e3),setTimeout(b,6e3),setTimeout(b,7e3),setTimeout(b,8e3),setTimeout(b,9e3),setTimeout(b,1e4)},addEnemy:function(){this.game.container.addEntity(new Opus.Enemy(this.game,this.container.offset.left+(this.cellSize*this.startCell.x+this.cellSize/2)-5,this.container.offset.top+(this.cellSize*this.startCell.y+this.cellSize/2)-5,10,10,{health:50,value:25,score:100}))},drawGrid:function(a){a.strokeStyle=this.settings.groundLineColor,a.lineWidth=1;for(var b=0;b<this.settings.cellsX;b++)for(var c=0;c<this.settings.cellsY;c++)switch(this.getMapElement(b,c)){case this.settings.mapNotation.ground:a.strokeStyle=this.settings.groundLineColor,a.strokeRect(this.container.offset.left+b*this.cellSize,this.container.offset.top+c*this.cellSize,this.cellSize,this.cellSize),a.fillStyle=this.settings.groundColor,a.fillRect(this.container.offset.left+b*this.cellSize,this.container.offset.top+c*this.cellSize,this.cellSize,this.cellSize);break;case this.settings.mapNotation.path:a.fillStyle=this.settings.pathColor,a.fillRect(this.container.offset.left+b*this.cellSize,this.container.offset.top+c*this.cellSize,this.cellSize,this.cellSize),a.strokeStyle=this.settings.pathColor,a.strokeRect(this.container.offset.left+b*this.cellSize,this.container.offset.top+c*this.cellSize,this.cellSize,this.cellSize);break;case this.settings.mapNotation.start:var d=a.createLinearGradient(150,0,150,300);d.addColorStop(0,"green"),d.addColorStop(.32,this.settings.pathColor),a.fillStyle="green",a.fillRect(this.container.offset.left+b*this.cellSize,this.container.offset.top+c*this.cellSize,this.cellSize,this.cellSize);break;case this.settings.mapNotation.end:var e=a.createLinearGradient(150,300,150,0);e.addColorStop(0,"red"),e.addColorStop(.1,this.settings.pathColor),a.fillStyle="red",a.fillRect(this.container.offset.left+b*this.cellSize,this.container.offset.top+c*this.cellSize,this.cellSize,this.cellSize);break;default:throw Error("Value not set in map notation ["+this.getMapElement(b,c)+"]")}return this},drawPathBorders:function(a){for(var b=0;b<this.settings.cellsX;b++)for(var c=0;c<this.settings.cellsY;c++)(this.getMapElement(b,c)==this.settings.mapNotation.path||this.getMapElement(b,c)==this.settings.mapNotation.start||this.getMapElement(b,c)==this.settings.mapNotation.end)&&(a.strokeStyle=this.settings.pathLineColor,a.beginPath(),this.getMapElement(b-1,c)==this.settings.mapNotation.ground&&(a.moveTo(this.container.offset.left+b*this.cellSize,this.container.offset.top+c*this.cellSize),a.lineTo(this.container.offset.left+b*this.cellSize,this.container.offset.top+c*this.cellSize+this.cellSize)),this.getMapElement(b+1,c)==this.settings.mapNotation.ground&&(a.moveTo(this.container.offset.left+b*this.cellSize+this.cellSize,this.container.offset.top+c*this.cellSize),a.lineTo(this.container.offset.left+b*this.cellSize+this.cellSize,this.container.offset.top+c*this.cellSize+this.cellSize)),this.getMapElement(b,c-1)==this.settings.mapNotation.ground&&(a.moveTo(this.container.offset.left+b*this.cellSize,this.container.offset.top+c*this.cellSize),a.lineTo(this.container.offset.left+b*this.cellSize+this.cellSize,this.container.offset.top+c*this.cellSize)),this.getMapElement(b,c+1)==this.settings.mapNotation.ground&&(a.moveTo(this.container.offset.left+b*this.cellSize,this.container.offset.top+c*this.cellSize+this.cellSize),a.lineTo(this.container.offset.left+b*this.cellSize+this.cellSize,this.container.offset.top+c*this.cellSize+this.cellSize)),a.stroke());return this},getMapElement:function(a,b){return this.settings.map[this.settings.cellsX*b+a]}},!0)}(),function(){Opus.Container=function(){this.containedEntities=[]},Opus.Helpers.extend(Opus.Container.prototype,{addEntity:function(a,b){return b||(a.zIndex=this.containedEntities.length),"number"==typeof b&&(a.zIndex=b),this.containedEntities.push(a),this.containedEntities.sort(this.sort),a},removeEntity:function(a){return this.containsEntity(a)&&this.containedEntities.splice(this.containedEntities.indexOf(a),1),this},containsEntity:function(a){return-1!==this.containedEntities.indexOf(a)},update:function(a){for(var b,c=this.containedEntities.length;c--,b=this.containedEntities[c];)b.update(a)},render:function(a){for(var b,c=this.containedEntities.length;c--,b=this.containedEntities[c];)b.render(a)},sort:function(a,b){return b.zIndex-a.zIndex}},!0)}(),function(){Opus.Player=function(){return this.money=500,this.lives=20,this.maxLives=20,this.level=0,this.score=0,this},Opus.Helpers.extend(Opus.Player.prototype,{addMoney:function(a){return this.money+=a,this},removeMoney:function(a){return this.money-=a,this},addScore:function(a){this.score+=a}},!0)}(),function(){Opus.Enemy=function(a,b,c,d,e,f){this.game=a,this.alive=!0,this.zIndex=NaN,this.width=d,this.height=e,this.position=new Opus.Vector2D(b,c),this.maxHealth=f.health,this.health=f.health,this.value=f.value,this.score=f.score,this.waypointCounter=1,this.nextWaypoint=this.game.activeMap.settings.cellWaypoints[this.waypointCounter],this.gridPosition={},this.direction=null,this.calculateDirection()},Opus.Helpers.extend(Opus.Enemy.prototype,{calculateDirection:function(){Math.floor(this.game.activeMap.container.offset.top+(this.game.activeMap.cellSize*this.nextWaypoint.y+this.game.activeMap.cellSize/2)-5)<Math.floor(this.position.y)?this.direction="up":Math.floor(this.game.activeMap.container.offset.top+(this.game.activeMap.cellSize*this.nextWaypoint.y+this.game.activeMap.cellSize/2))-5>Math.floor(this.position.y)?this.direction="down":Math.floor(this.game.activeMap.container.offset.left+(this.game.activeMap.cellSize*this.nextWaypoint.x+this.game.activeMap.cellSize/2))-5<Math.floor(this.position.x)?this.direction="left":Math.floor(this.game.activeMap.container.offset.left+(this.game.activeMap.cellSize*this.nextWaypoint.x+this.game.activeMap.cellSize/2))-5>Math.floor(this.position.x)&&(this.direction="right")},drawHealthBar:function(a){a.fillStyle="lightgreen";var b=this.health/this.maxHealth,c=this.width;a.fillRect(this.position.x,this.position.y-5,c*b,2)},render:function(a){return a.fillStyle="orange",a.fillRect(this.position.x,this.position.y,this.width,this.height),this.drawHealthBar(a),this},update:function(a){return this.alive&&(this.health<=0&&(this.alive=!1,this.game.player.addMoney(this.value),this.game.player.addScore(this.score),this.game.container.removeEntity(this)),this.gridPosition=this.game.activeMap.findGridCell(this.position.x,this.position.y),this.nextWaypoint.y>this.gridPosition.y?this.position.y++:this.nextWaypoint.y<this.gridPosition.y?this.position.y--:this.nextWaypoint.y==this.gridPosition.y&&this.nextWaypoint.x==this.gridPosition.x&&("down"==this.direction&&this.position.y++,"up"==this.direction&&this.position.y--),this.nextWaypoint.x>this.gridPosition.x?this.position.x++:this.nextWaypoint.x<this.gridPosition.x?this.position.x--:this.nextWaypoint.y==this.gridPosition.y&&this.nextWaypoint.x==this.gridPosition.x&&("right"==this.direction&&this.position.x++,"left"==this.direction&&this.position.x--),this.gridPosition.x==this.game.activeMap.endCell.x&&this.gridPosition.y==this.game.activeMap.endCell.y?(this.alive=!1,this.game.player.lives--,this.game.container.removeEntity(this)):this.gridPosition.x==this.nextWaypoint.x&&this.gridPosition.y==this.nextWaypoint.y&&Math.floor(this.position.x)==Math.floor(this.game.activeMap.container.offset.left+(this.game.activeMap.cellSize*this.nextWaypoint.x+this.game.activeMap.cellSize/2)-5)&&Math.floor(this.position.y)==Math.floor(this.game.activeMap.container.offset.top+(this.game.activeMap.cellSize*this.nextWaypoint.y+this.game.activeMap.cellSize/2)-5)&&(this.nextWaypoint=this.game.activeMap.settings.cellWaypoints[++this.waypointCounter],this.calculateDirection())),this}},!0)}(),function(){Opus.Game=function(a,b){return this.countFps=!1,this.animationFrameId=-1,Opus.Timer.init(),this.renderer=new Opus.Renderer(a,b),this.maps=[],this.towers=[],this.activeMap=null,this.input=new Opus.Input(this),this.UI=new Opus.UI(this,a,b),this.player=new Opus.Player,this.container=new Opus.Container,this.selectedTower=null,this.topLevelRenderObjects=[],this},Opus.Helpers.extend(Opus.Game.prototype,{render:function(){this.renderer.clearScreen("#16413c"),this.UI.render(this.renderer.getContext()),this.activeMap&&this.activeMap.render(this.renderer.getContext()),this.container.render(this.renderer.getContext());for(var a=0;a<this.topLevelRenderObjects.length;a++)this.topLevelRenderObjects[a](this.renderer.getContext()),this.topLevelRenderObjects.splice(a,1);return this.renderer.drawFrontBuffer(),this},update:function(a){return Opus.Timer.update(a),this.countFps===!0&&Opus.Timer.countFps(),this.activeMap&&this.activeMap.update(a),this.UI.update(a),this.container.update(a),this},addTopLevelRenderObject:function(a){this.topLevelRenderObjects.push(a)},gameLoop:function(a){return this.update(a),this.render(a),-1!==this.animationFrameId&&(this.animationFrameId=window.requestAnimationFrame(this.gameLoop.bind(this))),this},startGameLoop:function(){return-1===this.animationFrameId&&(this.animationFrameId=window.requestAnimationFrame(this.gameLoop.bind(this))),this},stopGameLoop:function(){return window.cancelAnimationFrame(this.animationFrameId),this.animationFrameId=-1,this},addMap:function(a){return this.maps.push(a),this},setActiveMap:function(a){return this.activeMap=a,this},addTower:function(a){return this.towers.push(a),this}},!0)}(),setTimeout(function(){window.CanvasTD=new Opus.Game(1024,600),CanvasTD.addMap(new Opus.Map(CanvasTD,{map:[".","S",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".","P",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".","P",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".","P","P","P","P",".",".",".",".",".",".",".","P","P","P","P","P","P","P",".",".",".",".",".",".",".","P",".",".",".",".",".",".",".","P",".",".",".",".",".","P",".",".",".",".",".",".",".","P",".",".","P","P","P","P",".","P","P","P",".",".",".","P",".",".",".",".",".",".",".","P",".",".","P",".",".","P",".",".",".","P",".","P","P","P",".",".",".",".",".",".",".","P","P","P","P",".",".","P",".",".",".","P",".","P",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".","P",".",".",".","P",".","P",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".","P","P","P",".","P",".","P",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".","P",".","P",".","P",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".","P",".","P",".","P",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".","P","P","P",".","P",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".","P",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".","P",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".","P",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".","P",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".","E",".",".",".",".","."],cellsX:22,cellsY:18,cellWaypoints:[{x:1,y:0},{x:1,y:3},{x:4,y:3},{x:4,y:7},{x:7,y:7},{x:7,y:5},{x:10,y:5},{x:10,y:9},{x:12,y:9},{x:12,y:12},{x:14,y:12},{x:14,y:5},{x:12,y:5},{x:12,y:3},{x:18,y:3},{x:18,y:6},{x:16,y:6},{x:16,y:18}]})).setActiveMap(CanvasTD.maps[0]).addTower({level:1,id:1,range:2,attacksPerSecond:20,damage:2,cost:100,name:"Laser Tower",color:"green",levelAvailable:1}).startGameLoop().input.addEvent("click",function(a){},{self:this})},1e3);
//# sourceMappingURL=CanvasTD.min.js.map